import{L as e,h as t}from"./lodash-b171aca0.js";import{Vector2 as i,Vector3 as s,PerspectiveCamera as n,Scene as o,Color as r,WebGLRenderTarget as h,AmbientLight as a,SpotLight as c,WebGLRenderer as l,Group as d,Matrix4 as p,Quaternion as m,MeshBasicMaterial as u,MeshPhongMaterial as g,Euler as w,Mesh as y,MeshLambertMaterial as f,Float32BufferAttribute as k}from"three";import x from"three/examples/jsm/libs/stats.module.js";import{GLTFLoader as b}from"three/examples/jsm/loaders/GLTFLoader.js";import{TrackballControls as j}from"three/examples/jsm/controls/TrackballControls.js";import{BufferGeometryUtils as M}from"three/examples/jsm/utils/BufferGeometryUtils.js";window.customElements.define("ray-cast",class extends e{static get properties(){return{container:{type:Object},stats:{type:Object},camera:{type:Object},controls:{type:Object},scene:{type:Object},renderer:{type:Object},pickingTexture:{type:Object},pickingScene:{type:Object},highlightShape:{type:Object},mouse:{type:Object},mousePosX:{type:Object},mousePosY:{type:Object},offset:{type:Object},pickingData:{type:Object},cursorType:{type:String},canClick:{type:Boolean},link:{type:String},duplicated:{type:Boolean},que:{type:Object}}}constructor(){super(),this.mouse=new i,this.mousePosX="0px",this.mousePosY="0px",this.offset=new s(1,1,1),this.duplicated=!1,this.pickingData=[],this.cursorType="grab",this.canClick=!1,this.link="",this.addEventListener("click",this.clickLink)}render(){return t`<style>:host{cursor:${this.cursorType}}.followMouse{top:${this.mousePosY};left:${this.mousePosX};background:#fff;position:absolute;z-index:10}</style><div id="container"></div>`}async firstUpdated(){await new Promise(e=>setTimeout(e,0)),this.init(),this.animate()}init(){this.container=this.shadowRoot.getElementById("container"),this.camera=new n(70,window.innerWidth/window.innerHeight,1,1e4),this.camera.position.z=1e3,this.scene=new o,this.scene.background=new r(4342338),this.pickingScene=new o,this.pickingTexture=new h(1,1),this.scene.add(new a(5592405));const e=new c(16777215,1.5);e.position.set(0,500,2e4),this.scene.add(e),this.que=this.loadModel("/src/assets/models/gltf/questionmark.glb"),this.thicQue=this.loadModel("/src/assets/models/gltf/questionmarkBig.glb"),this.renderer=new l({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.container.appendChild(this.renderer.domElement),this.controls=new j(this.camera,this.renderer.domElement),this.controls.rotateSpeed=-1,this.controls.zoomSpeed=1.2,this.controls.panSpeed=-.8,this.controls.noZoom=!1,this.controls.noPan=!1,this.controls.staticMoving=!0,this.controls.dynamicDampingFactor=.3,this.stats=new x,this.renderer.domElement.addEventListener("mousemove",this.onMouseMove.bind(this))}onMouseMove(e){this.mouse.x=e.clientX,this.mouse.y=e.clientY,this.mousePosX=this.mouse.x+15+"px",this.mousePosY=this.mouse.y+15+"px"}loadModel(e){var t=new b,i=new d;return t.load(e,(function(e){e.scene.traverse((function(e){})),i.add(e.scene)})),i}animate(){window.requestAnimationFrame(()=>this.animate()),0==this.duplicated&&this.duplicate(),1==this.duplicated&&(this.threeRender(),this.stats.update())}threeRender(){this.controls.update(),this.pick(),this.renderer.setRenderTarget(null),this.renderer.render(this.scene,this.camera)}duplicate(){var e=_.get(this.que,["children",0,"children"],null),t=_.get(this.thicQue,["children",0,"children"],null);if(e&&t){const e=[],t=[],h=new p,a=new m,c=new r,l=new u({vertexColors:!0}),d=new g({color:16777215,flatShading:!0,vertexColors:!0,shininess:0});var i=this.que.children[0].children.find(e=>"Mesh"==e.type).geometry,n=this.thicQue.children[0].children.find(e=>"Mesh"==e.type).geometry;for(let n=1;n<51;n++){var o=i.clone();const r=new s;r.x=1e4*Math.random()-5e3,r.y=6e3*Math.random()-3e3,r.z=8e3*Math.random()-4e3;const l=new w;l.x=2*Math.random()*Math.PI,l.y=2*Math.random()*Math.PI,l.z=2*Math.random()*Math.PI;const d=new s(50,50,50);a.setFromEuler(l),h.compose(r,a,d),o.applyMatrix4(h),this.applyVertexColors(o,c.setHex(394758)),e.push(o),o=o.clone(),this.applyVertexColors(o,c.setHex(n)),t.push(o),this.pickingData[n]={position:r,rotation:l,scale:d}}this.highlightShape=new y(n,new f({color:16728418})),this.scene.add(this.highlightShape);const k=new y(M.mergeBufferGeometries(e),d);this.scene.add(k),this.pickingScene.add(new y(M.mergeBufferGeometries(t),l)),this.duplicated=!0}}pick(){this.camera.setViewOffset(this.renderer.domElement.width,this.renderer.domElement.height,this.mouse.x*window.devicePixelRatio|0,this.mouse.y*window.devicePixelRatio|0,1,1),this.renderer.setRenderTarget(this.pickingTexture),this.renderer.render(this.pickingScene,this.camera),this.camera.clearViewOffset();const e=new Uint8Array(4);this.renderer.readRenderTargetPixels(this.pickingTexture,0,0,1,1,e);const t=e[0]<<16|e[1]<<8|e[2],i=this.pickingData[t];t>0&&(this.cursorType="pointer",this.link="src/what.html",this.canClick=!0),i&&t>0?i.position&&i.rotation&&i.scale&&(this.highlightShape.position.copy(i.position),this.highlightShape.rotation.copy(i.rotation),this.highlightShape.scale.copy(i.scale).add(this.offset),this.highlightShape.visible=!0):(this.highlightShape.visible=!1,this.cursorType="grab",this.canClick=!1)}clickLink(){this.canClick&&(window.location.href="src/what.html")}applyVertexColors(e,t){const i=e.attributes.position,s=[];for(let e=0;e<i.count;e++)s.push(t.r,t.g,t.b);e.setAttribute("color",new k(s,3))}});
